## Подготовка
Необходимые условия: 
1. Активированный Whitelist,
2. Майнящий первый узел,
3. Первый узел должен быть подключен к Интернету. Необходим публичный IP-адрес и открытый порт tcp/30303, udp/30303,
4. Необходим адрес enode первого узла. Его можно получить в web3-консоли. Запустить консоль на первом узле сети из директории `~/masterchain`:
```
./connectToRootNode.sh
```
Получить enode первого узла:
```
admin.nodeInfo.enode
```

Enode адрес имеет структуру enode://id@ip:port. Если вместо IP узел вернул `[::]`, заменить `[::]` на внешний IP-адрес первого узла.

5. Значение Whitelist address, полученное при создании genesis-файла.

## Запуск нового узла
Для запуска нового узла, необходимо иметь исполняемый файл `meth` и `masterchain-genesis.json` на любом компьютере, подключенном к сети Интернет. После сборки Мастерчейн:
* Исполняемый файл `meth` находится в директории `~/masterchain`,
* Genesis-файл `masterchain-genesis.json` находится в директории `~/masterchain/whitelist-utils/common-setup/out` первого узла. 

Добавление нового узла к сети Мастерчейн состоит из трёх шагов:
* Генерация ключей узла,
* Инициализация узла,
* Запуск узла,
* Добавление узла в Whitelist.

1. Перейти в директорию `~/masterchain`

2. Сгенерировать ключи для нового узла
```
./meth generate-node-keys --datadir %target_dir%
```

3. Инициализировать новый узел:
```
./meth --datadir %target_dir% --whitelist "%whitelist_address%" init ./whitelist-utils/common-setup/out/masterchain-genesis.json
```

4. Запустить узел: 
```
./meth --datadir %target_dir% --whitelist "%whitelist_address%" --bootnodes %enode_first_node% 
```

**Замечание**: в случае запуска второго узла на компьютере, где уже запущен экземпляр Мастерчейн (например, компьютер rootnode), необходимо явно указать номер порта для нового запускаемого узла, отличающийся от уже используемого другим экземпляром Мастерчейн и не занятым другими приложениями. В этом случае нужно запускать узел с дополнительным флагом `--port %номер порта%`. Пример: `--port 12121`.

## Регистрация нового узла в Whitelist

1. Получить адреса узлов. Для того чтобы получить адреса узлов без запуска web3 консоли (адреса необходимы для добавления в Whitelist), выполнить команды в незанятом терминале:

```
./meth --datadir %target_dir%  --exec "admin.nodeInfo.address" attach
./meth --datadir %target_dir%  --exec "admin.nodeInfo.server" attach
./meth --datadir %target_dir%  --exec "admin.nodeInfo.client" attach
```

Результатами выполнения команд будут соответственно адреса: ключа подписи для блоков, ключа сервера tls соединений, ключа клиента tls соединения.

2. На первом узле сети запустить Мастер управления Whitelist: в директории `~/masterchain/whitelist-utils/common-setup` выполнить команду: 
```
python3.6 WhitelistManagement.py
```
**Замечание:** Мастер управления Whitelist использует библиотеку web3.py, которая не работает с использованием системного python 3.5. Необходимо использовать python3.6.

3. Подключение происходит по `ipc`, указать адрес провайдера или использовать значение по умолчанию: `~/masterchain/masterchain_data/meth.ipc`.

После того, как адрес провайдера указан, Мастер управления Whitelist проверит состояние первого узла и запустит майнинг на первом узле, если майнинг не запущен.

4. Зарегистрировать новый узел в Whitelist для возможности синхронизации чейна: выбрать действие Register node server/client addresses

Мастер предложит пользователю ввести адреса серверного и клиентского ключей tls соединения нового узла, референс и адрес администратора Whitelist, который производит добавление. Значение маски для данных ключей выставляется в 1 (только чтение).

Мастер управления Whitelist произведёт следующие действия: 
* Выполнит проверку полномочий предоставленного выше адреса администратора и сообщит результат, если данная проверка не будет выполнена;
* Выполнит проверку возможности регистрации адресов нового узла и сообщит результат, если данная проверка не будет выполнена;
* Запросит ввод пароля для ключа администратора Whitelist, который производит добавление. В случае ошибки, будет возвращен код ошибки и её описание;
* Отправит транзакцию для каждого регистрируемого адреса. Результат транзакций будет возвращен в терминал. 
* Вернется в главное меню.

5. После того, как адрес узла добавлен в Whitelist, существующие узлы сети авторизуют соединение с новым узлом. После успешного соединения с другими узлами сети, новый узел начинает синхронизировать цепочку.

6. Зарегистрировать новый узел в Whitelist для возможности майнинга: выбрать действие Register node signer address

**Замечание:** Если провести данную регистрацию для новой ноды раньше, чем регистрацию для синхронизации, то нода при запуске майнинга начнет с 1-ого блока без связи с остальными нодами. При последующей регистрации для синхронизации с другими нодами смайненная цепочка будет заменена основной из общей сети.
  
Мастер предложит пользователю ввести адрес ключа подписи блоков нового узла, референс и адрес администратора Whitelist, который производит добавление. Значение маски для данных ключей выставляется в 2 (только майнинг).

Мастер управления Whitelist произведёт следующие действия: 
* Выполнит проверку полномочий предоставленного выше адреса администратора и сообщит результат, если данная проверка не будет выполнена;
* Выполнит проверку возможности регистрации адреса подписи блоков нового узла и сообщит результат, если данная проверка не будет выполнена;
* Запросит ввод пароля для ключа администратора Whitelist, который производит добавление. В случае ошибки, будет возвращен код ошибки и её описание;
* Отправит транзакцию. Результат транзакции будет возвращен в терминал. 
* Вернется в главное меню.

7. Если новому узлу назначена роль майнера, то рекомендуется перед началом майнинга назначить `coinbase` адрес к которому есть доступ, например, адрес администратора Whitelist или создать новый счёт и использовать адрес этого счёта. По умолчанию `coinbase` равен адресу подписи блоков узла.

Для создания нового счёта в директории узла выполнить команду:

```
./meth --datadir %target_dir% account new
```

Открыть web3 консоль для дополнительного узла:
```
./meth --preload ~/masterchain/compiled.js attach ./%target_dir%/meth.ipc
```

Выполнить команду:

```
miner.setEtherbase("%адрес_счёта%")
```

Замечание: если узел перезапустить, значение coinbase вернётся к значению по умолчанию.
